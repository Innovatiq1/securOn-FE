import { Component } from '@angular/core';
import { Router } from '@angular/router';
import {
  ApexAxisChartSeries,
  ApexChart,
  ChartComponent,
  ApexDataLabels,
  ApexYAxis,
  ApexLegend,
  ApexXAxis,
  ApexTooltip,
  ApexTheme,
  ApexGrid,
  ApexPlotOptions,
  ApexFill,
  NgApexchartsModule,
  ApexResponsive,
  ApexNonAxisChartSeries,
} from 'ng-apexcharts';
import { MaterialModule } from 'src/app/material.module';
import { VulnerabilityDataService } from 'src/app/services/api/shared.service';
type PieData = { [key: string]: number };
export type pieChart1Options = {
  series: ApexAxisChartSeries | ApexNonAxisChartSeries;
  chart: ApexChart;
  dataLabels: ApexDataLabels;
  plotOptions?: ApexPlotOptions;
  responsive: ApexResponsive[];
  labels?: string[];
  legend: ApexLegend;
  fill: ApexFill;
  colors: string[];
  tooltip: ApexTooltip;
};
@Component({
  selector: 'app-vulnerability-by-type',
  standalone: true,
  imports: [MaterialModule, NgApexchartsModule],
  templateUrl: './vulnerability-by-type.component.html',
})
export class VulnerabilityByTypeComponent {
  public typePieChartOptions: Partial<pieChart1Options> | any;
  byTypeData: any = null;
  loading: boolean = true;
  readonly cweLabelMapping: { [key: string]: string } = {
    'CWE-79': 'XSS',
    'CWE-89': 'SQL Injection',
    'CWE-22': 'Directory Traversal',
    'CWE-20': 'Input Validation',
    'CWE-352': 'CSRF',
    'CWE-200': 'Information Disclosure',
    'CWE-601': 'Open Redirect',
    'CWE-119': 'Memory Corruption',
    'CWE-98': 'File Inclusion',
    'CWE-611': 'XXE',
    'CWE-918': 'SSRF',
  };

  constructor(public vulnerabilityDataService: VulnerabilityDataService,public router: Router,)  {

    this.vulnerabilityDataService.vulnerabilitiesCwesData$.subscribe((data) => {
      if (data) {
        this.byTypeData = data; 
        this.loading = false;
        this.typePie(); 
      } else {
        this.loading = false; 
      }
    });
   
  }

  typePie(): void {
    const pieData: number[] = [];
    const pieLabels: string[] = [];
  
    if (this.byTypeData && this.byTypeData.data) {
      const dataEntries = this.byTypeData.data.split(',').map((entry: string) => {
        const [key, value] = entry.split(':').map(item => item.trim());
        return { key, value: Number(value) };  
      });
  
      dataEntries.forEach(({ key, value }: { key: string, value: number }) => {
      
        const label = this.cweLabelMapping[key];
        if (label && typeof value === 'number') {
          pieLabels.push(label);
          pieData.push(value);
        }
      });
  
      if (pieData.length > 0) {
        this.typePieChartOptions = {
          series: pieData,
          chart: {
            type: 'pie',
            fontFamily: 'inherit',
            foreColor: '#a1aab2',
            toolbar: { show: false },
            height: 320,
            events: {
              dataPointSelection: (
                event: Event,
                chartContext: any,
                config: { dataPointIndex: number }
              ) => {
                const clickedLabel = pieLabels[config.dataPointIndex];
                console.log("Clicked Label:", clickedLabel);
                this.router.navigate(['cve/vulnerabilty-viwe-by-type'], {
                  queryParams: { label: clickedLabel },
                });
              },
            },
          },
          labels: pieLabels,
          colors: [
            '#0070BA', '#F98D2B', '#43A047', '#0288D1', '#118e8683',
            '#FFCA28', '#217544', '#F39C12', '#00ACC1', '#F06292', '#054c8f83'
          ],
          plotOptions: {
            pie: {
              size: '75%',
              background: 'none',
              labels: {
                show: true,
                name: { show: false },
                value: { show: false, color: '#98aab4' },
              },
            },
          },
          dataLabels: { enabled: false },
          stroke: { show: false },
          legend: { show: true, labels: { colors: '#ffffff' }, position: 'bottom' },
          tooltip: { theme: 'dark', fillSeriesColor: false },
        };
      } else {
        console.warn("No data available for the pie chart.");
      }
    } else {
      console.error("No data available in byTypeData or byTypeData.data.");
    }
  }
  
  
  
  
  
  
}
